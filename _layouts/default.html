<!doctype html>
<html>
  <head>
    <title>{{ page.title }}</title>
    
    <link href="css/bootstrap/bootstrap.css" rel="stylesheet">
    <link href="css/lightbox/lightbox.css" rel="stylesheet" />
    <link href="css/githubiverse.css" rel="stylesheet" media="screen" type="text/css">

  </head>
  <body>
    {% if site.githubiverse.show_forkme_ribbon %}
    <a href="{{site.github_base}}{{page.github_user}}/{{page.github_repository}}"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"></a>{% endif %}

    <div class="container">
      <div class="row-fluid">
        <div class="span12">

          {% include header.html %}

          <div class="page-header">
            <h1 id="title">{{ page.title }}<small> by {{ page.author }}</small></h1>
          </div>
          
          <div class="row-fluid">
            <div class="span6">

              <ul id='thumbnails' class='thumbnails'></ul>

              <h3>Sources</h3>
              <div id="sources-section">
                <div class="row-fluid">
                  <div class="span9">
                    <ul id="sources" class="nav nav-tabs nav-stacked"></ul>
                  </div>
                  <div class="span3">
                    <ul id="sourcedownloads" class="nav nav-tabs nav-stacked"></ul>
                  </div>
                </div>
              </div>

            </div>


            <div class="span6">
              
              <div id="description">
                {{ content }}
              </div>

              <div id="tags" class="meta">
                <i class="icon-tags" title="tags"></i>&nbsp;
                {% for tag in page.tags %}
                  <a href="#" class="tag"><span class="label">{{ tag }}</span></a>
                {% endfor %}
              </div>

              <div id="author" class="meta"><i class='icon-user' title="user"></i>&nbsp;<a href="{{ site.github_base }}{{ page.github_user }}">{{ page.github_user }}</a></div>
              <div id="home" class="meta"><i class='icon-home' title="repository"></i>&nbsp;<a href="{{ site.github_base }}{{ page.github_repository }}">{{ page.github_repository }}</a></div>
              <div id="license" class="meta"><i class='icon-file' title="license"></i>&nbsp;{{ page.license }}</div>

              <h3>STLs</h3>
              <div id="stls-section">

                <div id="stlviewer"></div>

                <div class="row-fluid">
                  <div class="span9">
                    <ul id="stls" class="nav nav-tabs nav-stacked"></ul>
                  </div>
                  <div class="span3">
                    <ul id="stldownloads" class="nav nav-tabs nav-stacked"></ul>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {% include footer.html %}

        </div>
      </div>
    </div>

    <!-- Javascript -->

    <script src="http://code.jquery.com/jquery-1.8.1.min.js"> </script>
    <script src="js/bootstrap/bootstrap.min.js"></script>
    <script src="js/lightbox/lightbox.js"></script>
    <script src="js/thingiview/Three.js"></script>
    <script src="js/thingiview/plane.js"></script>
    <script src="js/thingiview/thingiview.js"></script>
    <script src="js/underscore/underscore.js"></script>
    <script src="js/github/gh3.js"></script>
    
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <script>

      function no_stls() {
        $('#stls-section').html('No STL Files Found.');
      }

      function no_sources() {
        $('#sources-section').html('No Source Files Found.');
      }

      $(document).ready(function(){
        autoloadSTL = {{ site.githubiverse.autoloadSTL }};
        thingiurlbase = "js/thingiview";
        thingiview = new Thingiview("stlviewer");
        thingiview.setObjectColor('#C0D8F0');
        thingiview.setBackgroundColor('#ffffff');
        thingiview.initScene();

        $('.stlfile').live('click', function(e){
          loadStlString($(this).data('githubFile'));
        });

        var githubUser = new Gh3.User("{{page.github_user}}"),
            githubRepositories = new Gh3.Repositories(githubUser),
            stl_file_count = 0,
            src_file_count = 0;

        function add_source_dir(dir, dirname){
          dir.fetchContents(function (err, res) {
            if(err) { throw "Error fetching contents for sources." }

            if (dirname == ''){
              dirname = dir.name; 
            } else {
              dirname = dirname+'/'+dir.name;
            }
                
            dir.eachContent(function (content) {
              if (content.type == 'file'){
                add_source_file(content, dirname);
              } else if (content.type == 'dir'){
                add_source_dir(content, dirname);
              }
            });
          });
        }

        function add_source_file(content,dirname){
          src_file_count++;
          if (dirname != ''){
            dirname = dirname+'/';
          }

          var fileGithubUrl = githubRepo.html_url + '/blob/' + content.branchName + '/' + content.path;
          var rawFileURL = githubRepo.html_url + '/raw/' + content.branchName + '/' + content.path;
          $('#sources').append("<li><a href='" + fileGithubUrl + "' target='_blank' title='View in Github' class=\"srcfile\">"+ dirname + content.name + "</a></li>");
          $('#sourcedownloads').append("<li><a class='btn-small btn-inverse' href='" + rawFileURL + "' download='" + content.name + "'><i class='icon-download-alt icon-white'></i>&nbsp;Download</a></li>");
        }

        function add_stl_dir(dir, dirname){
          dir.fetchContents(function (err, res) {
            if(err) { throw "Error fetching contents for stls." }

            if (dirname == ''){
              dirname = dir.name; 
            } else {
              dirname = dirname+'/'+dir.name;
            }
                
            dir.eachContent(function (content) {
              if (content.type == 'file'){
                add_stl_file(content, dirname);
              } else if (content.type == 'dir'){
                add_stl_dir(content, dirname);
              }
            });
          });
        }

        function add_stl_file(content,dirname){
          if (! /\.stl$/i.test(content.name)) {
            return
          }
          stl_file_count++;
          if (dirname != ''){
            dirname = dirname+'/';
          }

          var rawFileURL = githubRepo.html_url + '/raw/' + content.branchName + '/' + content.path;
          $('#stls').append("<li><a href=\"javascript://\" title='Preview' class=\"stlfile\">"+ dirname + content.name+"</a></li>")
          $('.stlfile').last().data("githubFile",content);
          $('#stldownloads').append("<li><a class='btn-small btn-inverse' href='" +  rawFileURL + "' download='" + content.name + "'><i class='icon-download-alt icon-white'></i>&nbsp;Download</a></li>");
        }

        function loadStlString(githubFile){
          if (githubFile == undefined || githubFile == '') return;
          
          thingiview.progressBarMessage('Retrieving File Data');

          githubFile.fetchContent(function (err, res) {
            if(err) { throw "Error retrieving github file contents." }

            thingiview.loadSTLString(githubFile.getRawContent());
          });
        }

        githubRepositories.fetch({page:1, per_page:100, direction : "desc"},"next", function (err, res) {
          if(err) { throw "Error fetching github repositories." }
        });

        githubRepo = new Gh3.Repository("{{page.github_repository}}", githubUser);
        githubRepo.fetch(function (err, res) {
          if(err) { throw "Error fetching github repository." }

          githubRepo.fetchBranches(function (err, res) {
            if(err) { throw "Error fetching github branches." }

            master = githubRepo.getBranchByName("{{page.github_branch}}");

            master.fetchContents(function (err, res) {
              if(err) { throw "Error fetching github repository contents." }

              var stlDir = master.getDirByName('{{ site.githubiverse.stl_dir }}');              
              if (stlDir == undefined){
                no_stls();
              } else {
                stlDir.fetchContents(function (err, res) {
                  if(err) { throw "Error fetching contents for stls." }

                  stlDir.eachContent(function (content) {
                      if (content.type == 'file'){
                        add_stl_file(content, '');
                      } else if (content.type == 'dir'){
                        add_stl_dir(content, '');
                      }
                  });

                  if (stl_file_count > 0){
                    if (autoloadSTL && $('.stlfile').first().text() != "") {
                      if ($('.stlfile').first().data('githubFile') != undefined){
                        loadStlString($('.stlfile').first().data('githubFile'));  
                      }                      
                    }  
                  } else {
                    no_stls();
                  }
                     
                });                
              }

              var srcDir = master.getDirByName('{{ site.githubiverse.src_dir }}');
              if (srcDir == undefined){
                no_sources();
              } else {
                srcDir.fetchContents(function (err, res) {
                  if(err) { throw "Error fetching contents for sources." }
                  
                  srcDir.eachContent(function (content) {
                    if (content.type == 'file'){
                      add_source_file(content, '');
                    } else if (content.type == 'dir'){
                      add_source_dir(content, '');
                    }
                  });
                
                  if (src_file_count == 0){
                    no_sources();
                  }

                });              
              }

              var imgDir = master.getDirByName('{{ site.githubiverse.img_dir }}');
              if (imgDir != undefined){
                imgDir.fetchContents(function (err, res) {
                  if(err) { throw "Error fetching contents for images." }
                  imgDir.eachContent(function (content) {
                    var rawFileURL = githubRepo.html_url + '/raw/' + content.branchName + '/' + content.path;
                    $('#thumbnails').append("<li><a class='thumbnail' href='" + rawFileURL + "' rel='lightbox[githubiverse]'><img class='imgfile' src='" + rawFileURL + "' alt='" + content.name + "' title='" + content.name + "' /></a></li>");
                  });
                });
              }

            });

          })
        });

      });

    </script>
  </body>
</html>